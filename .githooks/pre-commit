#!/bin/bash

# Pre-commit hook to ensure manifest.json version is updated when changes are made
# to the integration files

MANIFEST_FILE="custom_components/matriocontrol/manifest.json"
INTEGRATION_FILES="custom_components/matriocontrol/"

# Check if manifest.json exists
if [ ! -f "$MANIFEST_FILE" ]; then
    echo "‚ùå Error: $MANIFEST_FILE not found"
    exit 1
fi

# Get current version from manifest
CURRENT_VERSION=$(jq -r '.version' "$MANIFEST_FILE")

# Check if any integration files have been modified
if git diff --cached --name-only | grep -q "^$INTEGRATION_FILES"; then
    echo "üîç Integration files modified, checking version update..."
    
    # Get the previous version from the last commit
    if git rev-parse --verify HEAD >/dev/null 2>&1; then
        PREVIOUS_VERSION=$(git show HEAD:"$MANIFEST_FILE" 2>/dev/null | jq -r '.version' 2>/dev/null)
        
        if [ "$PREVIOUS_VERSION" = "null" ] || [ -z "$PREVIOUS_VERSION" ]; then
            echo "‚ÑπÔ∏è No previous version found (first commit or file didn't exist)"
            echo "‚úÖ Proceeding with current version: $CURRENT_VERSION"
        else
            echo "Previous version: $PREVIOUS_VERSION"
            echo "Current version: $CURRENT_VERSION"
            
            # Simple version comparison (assumes semantic versioning)
            if [ "$CURRENT_VERSION" = "$PREVIOUS_VERSION" ]; then
                echo "‚ùå Error: Version in $MANIFEST_FILE has not been updated"
                echo "   Please increment the version before committing changes to the integration"
                echo "   Current version: $CURRENT_VERSION"
                echo ""
                echo "üí° Tip: Update the version in $MANIFEST_FILE and stage the changes:"
                echo "   git add $MANIFEST_FILE"
                exit 1
            else
                echo "‚úÖ Version updated from $PREVIOUS_VERSION to $CURRENT_VERSION"
            fi
        fi
    else
        echo "‚ÑπÔ∏è No previous commit found (first commit)"
        echo "‚úÖ Proceeding with current version: $CURRENT_VERSION"
    fi
else
    echo "‚ÑπÔ∏è No integration files modified, skipping version check"
fi

echo "‚úÖ Pre-commit check passed"
exit 0
